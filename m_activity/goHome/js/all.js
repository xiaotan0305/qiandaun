var citys = 'bj|北京|beijing,tj|天津|tianjin,sh|上海|shanghai,dl|大连|dalian,jn|济南|jinan,qd|青岛|qingdao,sz|深圳|shenzhen,suzhou|苏州|suzhou,sy|沈阳|shenyang,sjz|石家庄|shijiazhuang,nanjing|南京|nanjing,gz|广州|guangzhou,zj|湛江|zhanjiang,zhenjiang|镇江|zhenjiang,zz|郑州|zhengzhou,taiyuan|太原|taiyuan,ts|唐山|tangshan,hz|杭州|hangzhou,hrb|哈尔滨|haerbin,yt|烟台|yantai,anshan|鞍山|anshan,qhd|秦皇岛|qinhuangdao,cq|重庆|chongqing,cd|成都|chengdu,cs|长沙|changsha,changchun|长春|changchun,jl|吉林|jilin,rz|日照|rizhao,pingdingshan|平顶山|pingdingshan,panjin|盘锦|panjin,anyang|安阳|anyang,wuhan|武汉|wuhan,cz|常州|changzhou,dg|东莞|dongguan,dy|东营|dongying,dz|德州|dezhou,daqing|大庆|daqing,dandong|丹东|dandong,datong|大同|datong,gy|贵阳|guiyang,hn|海南|hainan,hf|合肥|hefei,nm|呼和浩特|huhehaote,hd|邯郸|handan,nc|南昌|nanchang,nn|南宁|nanning,nb|宁波|ningbo,wuxi|无锡|wuxi,weihai|威海|weihai,wf|潍坊|weifang,xian|西安|xian,fs|佛山|foshan,fz|福州|fuzhou,fushun|抚顺|fushun,yz|扬州|yangzhou,lz|兰州|lanzhou,nt|南通|nantong,nanyang|南阳|nanyang,sanya|三亚|sanya,sx|绍兴|shaoxing,xn|西宁|xining,xm|厦门|xiamen,xz|徐州|xuzhou,km|昆明|kunming,huizhou|惠州|huizhou,ks|昆山|kunshan,changshu|常熟|changshu,chenzhou|郴州|chenzhou,chengde|承德|chengde,changzhi|长治|changzhi,bt|包头|baotou,bd|保定|baoding,bh|北海|beihai,baoji|宝鸡|baoji,binzhou|滨州|binzhou,bengbu|蚌埠|bengbu,benxi|本溪|benxi,baicheng|白城|baicheng,bozhou|亳州|bozhou,baoshan|保山|baoshan,bazhong|巴中|bazhong,baishan|白山|baishan,baiyin|白银|baiyin,huaian|淮安|huaian,heze|菏泽|heze,gaomi|高密|gaomi,st|汕头|shantou,xt|湘潭|xiangtan,xx|新乡|xinxiang,ls|丽水|lishui,tz|台州|taizhou,jx|嘉兴|jiaxing,jh|金华|jinhua,wz|温州|wenzhou,wj|吴江|wujiang,wlcb|乌兰察布|wulancabu,jc|晋城|jincheng,xj|乌鲁木齐|wulumuqi,mianyang|绵阳|mianyang,mas|马鞍山|maanshan,yc|宜昌|yichang,lyg|连云港|lianyungang,ly|洛阳|luoyang,liuzhou|柳州|liuzhou,lf|廊坊|langfang,lc|聊城|liaocheng,linyi|临沂|linyi,leshan|乐山|leshan,lvliang|吕梁|lvliang,liaoyang|辽阳|liaoyang,liaoyuan|辽源|liaoyuan,linfen|临汾|linfen,guilin|桂林|guilin,ganzhou|赣州|ganzhou,wuhu|芜湖|wuhu,shunde|顺德|shunde,qz|泉州|quanzhou,qiqihaer|齐齐哈尔|qiqihaer,yinchuan|银川|yinchuan,huzhou|湖州|huzhou,hs|衡水|hengshui,hengyang|衡阳|hengyang,hanzhong|汉中|hanzhong,yl|玉林|yulin,yk|营口|yingkou,jy|江阴|jiangyin,taizhou|泰州|taizhou,tc|太仓|taicang,taian|泰安|taian,tieling|铁岭|tieling,zs|中山|zhongshan,zhuzhou|株洲|zhuzhou,zh|珠海|zhuhai,zb|淄博|zibo,sq|宿迁|suqian,jm|江门|jiangmen,quzhou|衢州|quzhou,zhoushan|舟山|zhoushan,zjg|张家港|zhangjiagang,zhangjiakou|张家口|zhangjiakou,jiujiang|九江|jiujiang,jining|济宁|jining,anqing|安庆|anqing,fuyang|阜阳|fuyang,ahsuzhou|宿州|suzhou,fuxin|阜新|fuxin,zhangzhou|漳州|zhangzhou,longyan|龙岩|longyan,luohe|漯河|luohe,pingxiang|萍乡|pingxiang,jxfuzhou|抚州|fuzhou,erds|鄂尔多斯|eerduosi,enshi|恩施|enshi,qj|潜江|qianjiang,huangshi|黄石|huangshi,shiyan|十堰|shiyan,sanming|三明|sanming,xiangyang|襄阳|xiangyang,xingtai|邢台|xingtai,ezhou|鄂州|ezhou,xiaogan|孝感|xiaogan,xuchang|许昌|xuchang,xinzhou|忻州|xinzhou,xuancheng|宣城|xuancheng,huaihua|怀化|huaihua,huanggang|黄冈|huanggang,shaoguan|韶关|shaoguan,maoming|茂名|maoming,shangqiu|商丘|shangqiu,suihua|绥化|suihua,shaoyang|邵阳|shaoyang,songyuan|松原|songyuan,sanmenxia|三门峡|sanmenxia,mudanjiang|牡丹江|mudanjiang,zhaoqing|肇庆|zhaoqing,meizhou|梅州|meizhou,shanwei|汕尾|shanwei,qingyuan|清远|qingyuan,jieyang|揭阳|jieyang,zaozhuang|枣庄|zaozhuang,zhoukou|周口|zhoukou,zhumadian|驻马店|zhumadian,suizhou|随州|suizhou,jiaozuo|焦作|jiaozuo,jingzhou|荆州|jingzhou,jiamusi|佳木斯|jiamusi,jixi|鸡西|jixi,jian|吉安|jian,wuzhou|梧州|wuzhou,fangchenggang|防城港|fangchenggang,qinzhou|钦州|qinzhou,guigang|贵港|guigang,baise|百色|baise,hechi|河池|hechi,honghe|红河|honghe,guyuan|固原|guyuan,zigong|自贡|zigong,zhangjiajie|张家界|zhangjiajie,luzhou|泸州|luzhou,suining|遂宁|suining,neijiang|内江|neijiang,nanchong|南充|nanchong,meishan|眉山|meishan,guangan|广安|guangan,guangyuan|广元|guangyuan,ziyang|资阳|ziyang,ningde|宁德|ningde,nanping|南平|nanping,guan|固安|guan,ankang|安康|ankang,zunyi|遵义|zunyi,anshun|安顺|anshun,bijie|毕节|bijie,qujing|曲靖|qujing,qdn|黔东南|qiandongnan,zhaotong|昭通|zhaotong,lijiang|丽江|lijiang,luan|六安|luan,laiwu|莱芜|laiwu,lincang|临沧|lincang,chuxiong|楚雄|chuxiong,xishuangbanna|西双版纳|xishuangbanna,dali|大理|dali,dehong|德宏|dehong,xianyang|咸阳|xianyang,xinyang|信阳|xinyang,xinyu|新余|xinyu,xiangxi|湘西|xiangxi,xianning|咸宁|xianning,xianghe|香河|xianghe,liangshan|凉山|liangshan,hegang|鹤岗|hegang,hebi|鹤壁|hebi,huainan|淮南|huainan,huaibei|淮北|huaibei,huangshan|黄山|huangshan,huludao|葫芦岛|huludao,heyuan|河源|heyuan,hezhou|贺州|hezhou,heihe|黑河|heihe,dazhou|达州|dazhou,deyang|德阳|deyang,chaoyang|朝阳|chaoyang,chaohu|巢湖|chaohu,chizhou|池州|chizhou,chifeng|赤峰|chifeng,chuzhou|滁州|chuzhou,cangzhou|沧州|cangzhou,chaozhou|潮州|chaozhou,chongzuo|崇左|chongzuo,changde|常德|changde,weinan|渭南|weinan,yanan|延安|yanan,shangluo|商洛|shangluo,yancheng|盐城|yancheng,yueyang|岳阳|yueyang,yanbian|延边|yanbian,yingtan|鹰潭|yingtan,yuxi|玉溪|yuxi,yichun|宜春|yichun,sxyulin|榆林|yulin,yibin|宜宾|yibin,yongzhou|永州|yongzhou,shuozhou|朔州|shuozhou,zhongwei|中卫|zhongwei,jinchang|金昌|jinchang,tianshui|天水|tianshui,zhangye|张掖|zhangye,pingliang|平凉|pingliang,qingyang|庆阳|qingyang,longnan|陇南|longnan,zhuozhou|涿州|zhuozhou,tongchuan|铜川|tongchuan,tonghua|通化|tonghua,qiannan|黔南|qiannan,qianxinan|黔西南|qianxinan,puyang|濮阳|puyang,panzhihua|攀枝花|panzhihua,putian|莆田|putian,puer|普洱|puer,laibin|来宾|laibin,lps|六盘水|liupanshui,loudi|娄底|loudi,jinzhong|晋中|jinzhong,jinzhou|锦州|jinzhou,jingdezhen|景德镇|jingdezhen,jingmen|荆门|jingmen,jiayuguan|嘉峪关|jiayuguan,jiuquan|酒泉|jiuquan,shizuishan|石嘴山|shizuishan,wuzhong|吴忠|wuzhong,wuwei|武威|wuwei,shangrao|上饶|shangrao,siping|四平|siping,shuangyashan|双鸭山|shuangyashan,kelamayi|克拉玛依|kelamayi,changxing|长兴|changxing,xiantao|仙桃|xiantao,pingtan|平潭|pingtan,hechuan|合川|hechuan,wanzhou|万州|wanzhou,fuling|涪陵|fuling,qianjiang|黔江|qianjiang,qitaihe|七台河|qitaihe,qijiang|綦江|qijiang,tl|通辽|tongliao,tongling|铜陵|tongling,tongren|铜仁|tongren,kashi|喀什|kashi,kaifeng|开封|kaifeng,deqing|德清|deqing,dingxi|定西|dingxi,yili|伊犁|yili,yangjiang|阳江|yangjiang,yangquan|阳泉|yangquan,yaan|雅安|yaan,yiyang|益阳|yiyang,yunfu|云浮|yunfu,hljyichun|伊春|yichun,yuncheng|运城|yuncheng,yongchuan|永川|yongchuan,yanjiao|燕郊|yanjiao,yixing|宜兴|yixing,byne|巴彦淖尔|bayannaoer,bazhou|巴州|bazhou,akesu|阿克苏|akesu,shihezi|石河子|shihezi,changji|昌吉|changji,macau|澳门|macau,zy|招远|zhaoyuan,fq|福清|fuqing,tianmen|天门|tianmen,wenling|温岭|wenling,linhai|临海|linhai,zhuji|诸暨|zhuji,sxly|临猗|linyi,tengzhou|滕州|tengzhou,pingdu|平度|pingdu,xintai|新泰|xintai,zoucheng|邹城|zoucheng,xam|兴安盟|xinganmeng,pizhou|邳州|pizhou,xinghua|兴化|xinghua,rugao|如皋|rugao,taixing|泰兴|taixing,dongtai|东台|dongtai,qidong|启东|qidong,jiangdu|江都|jiangdu,haimen|海门|haimen,hnyz|禹州|yuzhou,changge|长葛|changge,yanling|鄢陵|yanling,yangchun|阳春|yangchun,huoqiu|霍邱|huoqiu,tongcheng|桐城|tongcheng,liyang|溧阳|liyang,nanchuan|南川|nanchuan,ruzhou|汝州|ruzhou,sg|寿光|shouguang,abazhou|阿坝州|abazhou,fengdu|丰都|fengdu,haining|海宁|haining,tongliang|铜梁|tongliang,jiangjin|江津|jiangjin,changshou|长寿|changshou,cixi|慈溪|cixi,lasa|拉萨|lasa,yuyao|余姚|yuyao,tongxiang|桐乡|tongxiang,shangyu|上虞|shangyu,pinghu|平湖|pinghu,zjfy|富阳|fuyang,ninghai|宁海|ninghai,feicheng|肥城|feicheng,laizhou|莱州|laizhou,zouping|邹平|zouping,jiaonan|胶南|jiaonan,longkou|龙口|longkou,xinyi|新沂|xinyi,gaoyou|高邮|gaoyou,jingjiang|靖江|jingjiang,zunhua|遵化|zunhua,qianan|迁安|qianan,nanan|南安|nanan,longhai|龙海|longhai,huian|惠安|huian,changle|长乐|changle,shishi|石狮|shishi,gongyi|巩义|gongyi,pulandian|普兰店|pulandian,kaiping|开平|kaiping,taishan|台山|taishan,enping|恩平|enping,rudong|如东|rudong,yizheng|仪征|yizheng,jintan|金坛|jintan,jimo|即墨|jimo,laixi|莱西|laixi,changyi|昌邑|changyi,guangrao|广饶|guangrao,penglai|蓬莱|penglai,linan|临安|linan,jiande|建德|jiande,zjtl|桐庐|tonglu,zjxs|象山|xiangshan,yuhuan|玉环|yuhuan,xinzheng|新郑|xinzheng,xingyang|荥阳|xingyang,yichuan|伊川|yichuan,yanshi|偃师|yanshi,wafangdian|瓦房店|wafangdian,donggang|东港|donggang,fengcheng|凤城|fengcheng,feixi|肥西|feixi,nongan|农安|nongan,ruijin|瑞金|ruijin,haian|海安|haian,fenghua|奉化|fenghua,jssn|睢宁|suining,jsfx|丰县|fengxian,peixian|沛县|peixian,anqiu|安丘|anqiu,qingzhou|青州|qingzhou,linqu|临朐|linqu,chunan|淳安|chunan,zhongmou|中牟|zhongmou,dengfeng|登封|dengfeng,pengzhou|彭州|pengzhou,dangyang|当阳|dangyang,yidu|宜都|yidu,fjax|安溪|anxi,lianjiang|连江|lianjiang,lujiang|庐江|lujiang,feidong|肥东|feidong,dangtu|当涂|dangtu,jinxian|进贤|jinxian,xinjian|新建|xinjian,zhaodong|肇东|zhaodong,binxian|宾县|binxian,anda|安达|anda,anning|安宁|anning,yongdeng|永登|yongdeng,yuzhong|榆中|yuzhong,huidong|惠东|huidong,baoying|宝应|baoying,sdjy|济阳|jiyang,sdsh|商河|shanghe,sdcl|昌乐|changle,laiyang|莱阳|laiyang,hnxa|新安|xinan,hnyy|宜阳|yiyang,xinmi|新密|xinmi,dingzhou|定州|dingzhou,xinji|辛集|xinji,luanxian|滦县|luanxian,yutian|玉田|yutian,lnzh|庄河|zhuanghe,xinmin|新民|xinmin,liaozhong|辽中|liaozhong,scjt|金堂|jintang,qionglai|邛崃|qionglai,liuyang|浏阳|liuyang,ningxiang|宁乡|ningxiang,yongchun|永春|yongchun,ahcf|长丰|changfeng,dehui|德惠|dehui,jlys|榆树|yushu,lantian|蓝田|lantian,shuyang|沭阳|shuyang,zhangqiu|章丘|zhangqiu,jiyuan|济源|jiyuan,ganzi|甘孜|ganzi,hlbe|呼伦贝尔|hulunbeier,xlglm|锡林郭勒盟|xilinguolemeng,dxal|大兴安岭|dxal,nujiang|怒江|nujiang,diqing|迪庆|diqing,hetian|和田|hetian,tulufan|吐鲁番|tulufan,hami|哈密|hami,kzls|克孜勒苏|kezilesu,betl|博尔塔拉|boertala,linxia|临夏|linxia,gannan|甘南|gannan,rikaze|日喀则|rikaze,changdu|昌都|changdu,naqu|那曲|naqu,haidong|海东|haidong,haixi|海西|haixi,songxian|嵩县|songxian,hbjz|晋州|jinzhou,luannan|滦南|luannan,zhijiang|枝江|zhijiang,gdlm|龙门|longmeng,sdpy|平阴|pingyin,luoning|洛宁|luoning,mengjin|孟津|mengjin,ruyang|汝阳|ruyang,gaobeidian|高碑店|gaobeidian,hbzx|赵县|zhaoxian,hbwj|无极|wuji,hbql|青龙|qinglong,hblt|乐亭|laoting,qianxi|迁西|qianxi,faku|法库|faku,kangping|康平|kangping,chongzhou|崇州|chongzhou,dayi|大邑|dayi,huxian|户县|huxian,zhouzhi|周至|zhouzhi,hengxian|横县|hengxian,gxby|宾阳|bingyang,wuchang|五常|wuchang,shangzhi|尚志|shangzhi,bayan|巴彦|bayan,yilan|依兰|yilan,qingxu|清徐|qingxu,kaiyang|开阳|kaiyang,xiuwen|修文|xiuwen,jr|句容|jurong,linqing|临清|linqing,wenan|文安|wenan,xinle|新乐|xinle,hbys|元氏|yuanshi,liling|醴陵|liling,youxian|攸县|youxian,xiangxiang|湘乡|xiangxiang,huaiyuan|怀远|huaiyuan,wuhe|五河|wuhe,guzhen|固镇|guzhen,zhaozhou|肇州|zhaozhou,zhaoyuan|肇源|zhaoyuan,ynyl|宜良|yiliang,dongfang|东方|dongfang,boluo|博罗|boluo,heshan|鹤山|heshan,qixia|栖霞|qixia,haiyang|海阳|haiyang,hbbz|霸州|bazhou,changli|昌黎|changli,hbps|平山|pingshan,dujiangyan|都江堰|dujiangyan,xinjin|新津|xinjin,qingzhen|清镇|qingzhen,danzhou|儋州|danzhou,wanning|万宁|wanning,hailin|海林|hailin,wuan|武安|wuan,yangqu|阳曲|yangqu,gaoling|高陵|gaoling,zhenhai|镇海|zhenhai,wujiaqu|五家渠|wujiaqu,jncq|长清|changqing,jiaozhou|胶州|jiaozhou,ytcd|长岛|changdao,njgc|高淳|gaochun,quanshan|泉山|quanshan,tongshan|铜山|tongshan,funing|阜宁|funing,jiangyan|姜堰|jiangyan,yongning|邕宁|yongning,cswc|望城|wangcheng,whhn|汉南|hannan,dengzhou|邓州|dengzhou,lankao|兰考|lankao,ksys|玉山|yushan,renqiu|任丘|renqiu,luoyuan|罗源|luoyuan,minqing|闽清|minqing,yongtai|永泰|yongtai,quangang|泉港|quangang,wenshan|文山|wenshan,wuhai|乌海|wuhai,dazu|大足|dazu,bishan|璧山|bishan,tongnan|潼南|tongnan,jianyang|简阳|jianyang,leiyang|耒阳|leiyang,tjjx|蓟县|jixian,hbjs|京山|jingshan,fuan|福安|fuan,huadian|桦甸|huadian,lnta|台安|taian,luanchuan|栾川|luanchuan,puning|普宁|puning,jxfc|丰城|fengcheng,haicheng|海城|haicheng,gongzhuling|公主岭|gongzhuling,xilinhaote|锡林浩特|xilinhaote,fanchang|繁昌|fanchang,jinhu|金湖|jinhu,emeishan|峨眉山|emeishan,huairen|怀仁|huairen,zhongxiang|钟祥|zhongxiang,kuitun|奎屯|kuitun,jxja|靖安|jingan,yongcheng|永城|yongcheng,ya|永安|yongan,dh|德化|dehua,shennongjia|神农架|shennongjia,cn|常宁|changning,alsm|阿拉善盟|alashanmeng,lhk|老河口|laohekou,hbzy|枣阳|zaoyang,hailaer|海拉尔|hailaer,haibei|海北|haibei,hbyc|宜城|yicheng,wg|舞钢|wugang,huangnan|黄南|huangnan,guoluo|果洛|guoluo,hbsz|深州|shenzhou,jz|冀州|jizhou,yushu|玉树|yushu,hbsh|三河|sanhe,linzhi|林芝|linzhi,haiyan|海盐|haiyan,twproperty|台湾|taiwan,vancouer|温哥华|wengehua,hkproperty|香港|xianggang,sgproperty|新加坡|xinjiapo';
$(document).ready(function () {
    var body = $('body');

    /**
     * [getGeo 获取经纬度]
     * @param  {[type]}   location [description]
     * @param  {Function} callback [description]
     * @return {[type]}            [description]
     */
    function getGeo(loca, callback) {
        myGeo.getPoint(loca, function (point) {
            // console.log(point);
            if (point) {
                callback && callback(point);
            } else {
                alert('请重新输入并选择「' + loca + '」的省市区');
            }
        });
    }

    /**
     * [getDistance 根据经纬度获取距离]
     * @param  {[obj]} p1 [经纬度1]
     * @param  {[obj]} p2 [经纬度2]
     */
    function getDistance(p1, p2, callback) {
        // 距离公里数，取整。
        var distance = ~~(map.getDistance(p1, p2) / 1000);
        // console.log(distance);
        if (distance) {
            callback && callback(distance);
        } else {
            alert('请尽可能输入准确的地址');
        }
    }

    /**
     * [jumpPage 跳转页面]
     * @param  {[num]} distance [距离]
     */
    function jumpPage(distance, a, b, mCity, mDist, parentCity, parentDist) {
        var hash = 'dis=' + distance + '&ay=' + a.lat + '&ax=' + a.lng + '&by=' + b.lat + '&bx=' + b.lng + '&mc=' + (mCity || '') + '&md=' + (mDist || '') + '&pc=' + (parentCity || '') + '&pd=' + (parentDist || '');
        if (distance < 100) {
            location.href = location.href.replace(/index./g, 'near.') + '!@' + hash;
        } else if (distance > 100 && distance < 300) {
            location.href = location.href.replace(/index./g, 'mid.') + '!@' + hash;
        } else if (distance > 300) {
            location.href = location.href.replace(/index./g, 'far.') + '!@' + hash;
        }
    }

    /**
     * [getData 拆url]
     * @param  {[type]} url [url]
     * @return {[type]}     [url带的数据，键值形式]
     */
    function getData(url) {
        var result = {};
        var temp = url.split('!@')[1].split('&');
        for (var i in temp) {
            var s = temp[i].split('=');
            result[s[0]] = s[1];
        }
        return result;
    }


    // 根据原始数据计算中心坐标和缩放级别，并为地图设置中心坐标和缩放级别。
    function setZoom(points, distance) {
        if (points.length > 0) {
            var maxLng = points[0].lng;
            var minLng = points[0].lng;
            var maxLat = points[0].lat;
            var minLat = points[0].lat;
            var res;
            for (var i = points.length - 1; i >= 0; i--) {
                res = points[i];
                if (res.lng > maxLng) maxLng = res.lng;
                if (res.lng < minLng) minLng = res.lng;
                if (res.lat > maxLat) maxLat = res.lat;
                if (res.lat < minLat) minLat = res.lat;
            }
            var cenLng = (parseFloat(maxLng) + parseFloat(minLng)) / 2;
            var cenLat = (parseFloat(maxLat) + parseFloat(minLat)) / 2;
            var zoom = getZoom(maxLng, minLng, maxLat, minLat, distance);
            // console.log(zoom, cenLng, cenLat);
            if (distance > 800) {
                cenLat += 2;
            }
            map.centerAndZoom(new BMap.Point(cenLng, cenLat), zoom);
        } else {
            // 没有坐标，显示全中国。
            map.centerAndZoom(new BMap.Point(103.388611, 35.563611), 5);
        }
    }

    // 根据经纬极值计算绽放级别。本例核心代码。
    function getZoom(maxLng, minLng, maxLat, minLat, distance) {
        // 级别18到3。
        var zoom = ['50', '100', '200', '500', '1000', '2000', '5000', '10000', '20000', '25000', '50000', '100000', '200000', '500000', '1000000','2000000'];
        distance *= 1000;
        var z = 3;
        for (var i = 0, zoomLen = zoom.length; i < zoomLen; i++) {
            if (zoom[i] - distance > 0) {
                // 之所以会多3，是因为地图范围常常是比例尺距离的10倍以上。所以级别会增加3。
                // return 18 - i - 9;
                return 18 - i + 1;
            }
        }
        return z;
    }

    // 在轨迹点上创建图标，并添加点击事件
    function addMarker(points) {
        var point, marker;
        // 创建标注对象并添加到地图
        for (var i = 0, pointsLen = points.length; i < pointsLen; i++) {
            point = new BMap.Point(points[i].lng, points[i].lat);
            // marker = new BMap.Marker(point);
            // map.addOverlay(marker);
            var txt = '银湖海岸城';

            var myCompOverlay = new ComplexCustomOverlay(new BMap.Point(points[i].lng, points[i].lat), txt, points[i].img);

            map.addOverlay(myCompOverlay);
        }
    }

    // 复杂的自定义覆盖物
    function ComplexCustomOverlay(point, text, img) {
        this.point = point;
        this.text = text;
        this.img = img;
    }
    ComplexCustomOverlay.prototype = new BMap.Overlay();
    ComplexCustomOverlay.prototype.initialize = function (map) {
        this.map = map;
        var div = this.div = document.createElement('div');
        div.style.position = 'absolute';
        div.style.zIndex = BMap.Overlay.getZIndex(this.point.lat);
        div.style.background = 'url("' + this.img + '") no-repeat';
        div.style.color = 'white';
        div.style.width = '1.3rem';
        div.style.height = '1.65rem';
        div.style.MozUserSelect = 'none';
        div.style.backgroundSize = 'cover';
        // var span = this.span = document.createElement('span');
        // div.appendChild(span);
        // span.appendChild(document.createTextNode(this.text));

        var arrow = this.arrow = document.createElement('div');
        arrow.style.background = 'url("//static.soufunimg.com/common_m/m_activity/goHome/images/icon_b.png") no-repeat';
        arrow.style.position = 'absolute';
        arrow.style.width = '0.375rem';
        arrow.style.height = '0.6rem';
        arrow.style.top = '35px';
        arrow.style.left = '-5px';
        arrow.style.backgroundSize = 'cover';
        div.appendChild(arrow);

        map.getPanes().labelPane.appendChild(div);

        return div;
    };
    ComplexCustomOverlay.prototype.draw = function () {
        var map = this.map;
        var pixel = map.pointToOverlayPixel(this.point);
        this.div.style.left = pixel.x + 'px';
        this.div.style.top = pixel.y - 50 + 'px';
    };

    function getPYbyCN(cn) {
        var cityArr = citys.split(','),
            i = 0,
            len = cityArr.length;
        for (; i < len; i++) {
            var thisArr = cityArr[i].split('|');
            if (cn.indexOf(thisArr[1]) > -1) {
                return thisArr[0];
            }
        }
        // console.log('百度地图返回的数据在数据表里匹配不到');
    }

    if (body.hasClass('input')) {

        var map = new BMap.Map();
        var myGeo = new BMap.Geocoder();

        var myCityUl = $('#myCityUl'),
            pCityUl = $('#pCityUl'),
            myInput = '',
            pInput = '',
            mCity = '',
            mDist = '',
            parentCity = '',
            parentDist = '',
            myResult = '',
            pResult = '',
            myCityInput = $('#myCityInput'),
            pCityInput = $('#pCityInput');

        $('.main').append('<div id="mask"></div>');
        var mask = $('#mask');
        mask.on('click', function () {
            mask.hide();
            myCityUl.hide();
            pCityUl.hide();
        });

        var isSelected = false;

        $('#myCityInput,#pCityInput').on('focus', function (ev) {
            ev.stopPropagation();
            // var val = $(this).val();
            // if (val === '请输入我的位置' || val === '请输入父母的位置') {
            //     $(this).val('');
            // }
            // if (ev.target.id === 'myCityInput') {
            //     myCityInput.css('color', '#3d2a1d');
            //     myCityInput.attr('placeholder','');
            // }
            // if (ev.target.id === 'pCityInput') {
            //     pCityInput.css('color', '#3d2a1d');
            //     pCityInput.attr('placeholder','');
            // }

            setTimeout(function () {
                $('body').animate({
                    scrollTop: 200
                });
            },666);
        }).on('blur', function (ev) {
            ev.stopPropagation();
            // if ($(this).val() === '') {
            //     if (ev.target.id === 'myCityInput') {
            //         myCityInput.val('请输入我的位置').css('color', '#ccc');
            //     }
            //     if (ev.target.id === 'pCityInput') {
            //         pCityInput.val('请输入父母的位置').css('color', '#ccc');
            //     }
            // }
            // setTimeout(function () {
            //     mask.hide();
            //     myCityUl.hide();
            //     pCityUl.hide();
            // },666);
        }).on('input', function (ev) {
            ev.preventDefault();
            isSelected = false;
        });

        var myCity = new BMap.Autocomplete({
            // 建立一个自动完成的对象
            input: 'myCityInput',
            onSearchComplete: function (e) {
                // console.log(e);
                $('.tangram-suggestion-main').hide();
                if (e.xr) {
                    var i = 0,
                        len = e.xr.length,
                        listHTML = '';
                    for (; i < len; i++) {
                        // listHTML += '<li data-city=' + e.xr[i].city + ' data-dist=' + e.xr[i].district + '>' + e.xr[i].province + e.xr[i].city + e.xr[i].district + e.xr[i].business + '</li>';
                        listHTML += '<li data-province="' + e.xr[i].province + '" data-city="' + e.xr[i].city + '" data-dist="' + e.xr[i].district + '">' + e.xr[i].business + '</li>';
                    }
                    if (listHTML) {
                        myCityUl.html(listHTML).show();
                        mask.show();
                    }else {
                        myCityUl.hide();
                        mask.hide();
                    }
                }
            }
        });
        var pCity = new BMap.Autocomplete({
            // 建立一个自动完成的对象
            input: 'pCityInput',
            onSearchComplete: function (e) {
                // console.log(e);
                $('.tangram-suggestion-main').hide();
                if (e.xr) {
                    var i = 0,
                        len = e.xr.length,
                        listHTML = '';
                    for (; i < len; i++) {
                        // listHTML += '<li data-city=' + e.xr[i].city + ' data-dist=' + e.xr[i].district + '>' + e.xr[i].province + e.xr[i].city + e.xr[i].district + e.xr[i].business + '</li>';
                        listHTML += '<li data-province="' + e.xr[i].province + '" data-city="' + e.xr[i].city + '" data-dist="' + e.xr[i].district + '">' + e.xr[i].business + '</li>';
                    }
                    if (listHTML) {
                        pCityUl.html(listHTML).show();
                        mask.show();
                    }else {
                        pCityUl.hide();
                        mask.hide();
                    }
                    // console.log(listHTML);
                }
            }
        });

        myCityUl.on('click', 'li', function (ev) {
            ev.stopPropagation();
            var $this = $(this);
            // 获取下拉菜单项的文字
            myInput = $this.html();
            // 隐藏菜单
            myCityUl.hide();
            // 把菜单项内容插入输入框
            myCity.setInputValue(myInput);
            // 暂存百度返回结果 - 城市
            var selectedCity = $this.attr('data-city') ? $this.attr('data-city') : '';
            // 暂存百度返回结果 - 区县
            var selectedDist = $this.attr('data-dist') ? $this.attr('data-dist') : '';
            // 根据中文名获取拼音 - 城市
            mCity = getPYbyCN(selectedCity.replace(/市/g,''));
            // 根据中文名获取拼音 - 区县
            mDist = selectedDist.replace(/新区/g,'').replace(/区/g,'');
            // 拼接返回的完整数据，便于获取坐标
            myResult = $this.attr('data-province') + $this.attr('data-city') + $this.attr('data-dist') + $this.html();
            // 样式
            myCityInput.css('color', '#3d2a1d');
            if (!mCity) {
                var city = myInput.split('省')[1] ? myInput.split('省')[1].split('市')[0] : myInput.split('市')[0] ? myInput.split('市')[0] : '';
                mCity = getPYbyCN(city) || '';
            }
            mask.hide();
            isSelected = true;
            // console.log('param：',mCity,mDist);
            // console.log('data：',$this.attr('data-city'),$this.attr('data-dist'));
        });

        pCityUl.on('click', 'li', function (ev) {
            ev.stopPropagation();
            var $this = $(this);
            pInput = $this.html();
            pCityUl.hide();
            pCity.setInputValue(pInput);
            var selectedCity = $this.attr('data-city') ? $this.attr('data-city') : '';
            var selectedDist = $this.attr('data-dist') ? $this.attr('data-dist') : '';
            parentCity = getPYbyCN(selectedCity.replace(/市/g,''));
            parentDist = selectedDist.replace(/新区/g,'').replace(/区/g,'');
            // 完整数据
            pResult = $this.attr('data-province') + $this.attr('data-city') + $this.attr('data-dist') + $this.html();
            // 样式
            pCityInput.css('color', '#3d2a1d');
            if (!parentCity) {
                var city = pInput.split('省')[1] ? pInput.split('省')[1].split('市')[0] : pInput.split('市')[0];
                parentCity = getPYbyCN(city) || '';
            }
            mask.hide();
            isSelected = true;
            // console.log('param：',parentCity,parentDist);
            // console.log('data：',$this.attr('data-city'),$this.attr('data-dist'));
        });

        $('#count').on('click', function (ev) {
            ev.stopPropagation();
            if (!myCityInput.val()) {
                alert('请输入我的位置');
            }else if (!pCityInput.val()) {
                alert('请输入父母的位置');
            }else if (!isSelected) {
                alert('只能使用下拉列表中的地址');
            } else{
                // 获取自己的位置
                getGeo(myResult, function (myPoint) {
                    // 获取父母的位置
                    getGeo(pResult, function (pPoint) {
                        // 根据位置获取距离
                        getDistance(myPoint, pPoint, function (distance) {
                            jumpPage(distance, myPoint, pPoint,mCity,mDist,parentCity,parentDist);
                        });
                    });
                });
            }
        });
    } else if (body.hasClass('result')) {
        // 获取url参数
        var urlData = getData(location.href);
        var distance = urlData.dis,
            ax = urlData.ax * 1,
            ay = urlData.ay * 1,
            bx = urlData.bx * 1,
            by = urlData.by * 1,
            mc = urlData.mc || '',
            md = urlData.md || '',
            pc = urlData.pc || '',
            pd = urlData.pd || '';
        // console.log(ax, ay, bx, by, mc, md, pc, pd);
        $('#distance').html(distance);

        // 数据准备
        var points = [{
            lng: ax,
            lat: ay,
            img: '//static.soufunimg.com/common_m/m_activity/goHome/images/icon_r1.png'
        }, {
            lng: bx,
            lat: by,
            img: '//static.soufunimg.com/common_m/m_activity/goHome/images/icon_r2.png'
        }];
        // 初始化地图
        var map = new BMap.Map('map');
        // 设置中心点和缩放级别。
        setZoom(points, distance);
        // 把原始数据的轨迹点添加到地图上。
        addMarker(points);
        // 滚轮放大缩小
        map.enableScrollWheelZoom();

        if (distance <= 100) {
            $('#jumpFangNear').attr('href','//m.fang.com/zf/?c=zf&a=index&purpose=住宅&type=0&keyword=' + pd + '&city=' + pc + '&r=' + new Date().getTime());
        }else if (distance > 100 && distance < 300) {
            $('#jumpFangMid').attr('href','//m.fang.com/zf/?c=zf&a=index&purpose=住宅&type=0&keyword=' + md + '&city=' + mc + '&r=' + new Date().getTime());
        }else if (distance >= 300) {
            $('#jumpFangFar').attr('href','//m.fang.com/zf/?c=zf&a=index&purpose=住宅&type=0&keyword=' + md + '&city=' + mc + '&r=' + new Date().getTime());
        }
        // $('#jumpFangFar,#jumpFangNear,#jumpFangMid').on('click', function () {
        // });
    }

    // 微信、QQ分享
    var weixin = new Weixin({
        // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        debug: false,
        shareTitle: '朋友，有多久没回家了',
        descContent: '朋友，有多久没回家了',
        lineLink: 'http://m.fang.com/activityshow/backToHome/index.jsp?channel=rentcenter',
        imgUrl: location.protocol + '//static.soufunimg.com/common_m/m_activity/goHome/images/share.jpg'
    });

});
